---
# Upload ZFS encryption key to 1Password as a document attachment
# Requires: op CLI installed, OP_SERVICE_ACCOUNT_TOKEN environment variable set

- name: Verify 1Password CLI is installed
  ansible.builtin.command:
    cmd: op --version
  delegate_to: localhost
  become: false
  register: op_version
  changed_when: false
  failed_when: op_version.rc != 0

- name: Set key title for 1Password
  ansible.builtin.set_fact:
    op_key_title: "{{ vault_key_title_template }}"

- name: Check if document already exists in 1Password
  ansible.builtin.shell:
    cmd: >
      op item list --vault "{{ onepassword_vault }}"
      --categories Document
      --format json | jq -r '.[] | select(.title == "{{ op_key_title }}") | .id'
  delegate_to: localhost
  become: false
  register: op_existing_item
  changed_when: false
  failed_when: false
  environment:
    OP_SERVICE_ACCOUNT_TOKEN: "{{ lookup('env', 'OP_SERVICE_ACCOUNT_TOKEN') }}"

- name: Upload new document to 1Password
  ansible.builtin.command:
    cmd: >
      op document create
      "{{ local_key_backup_dir }}/{{ inventory_hostname }}_zfs_drivekey.bin"
      --vault "{{ onepassword_vault }}"
      --title "{{ op_key_title }}"
      --tags "{{ onepassword_tags | join(',') }}"
  delegate_to: localhost
  become: false
  register: op_create_result
  when: op_existing_item.stdout == ""
  failed_when: vault_fail_on_upload_error and op_create_result.rc != 0
  environment:
    OP_SERVICE_ACCOUNT_TOKEN: "{{ lookup('env', 'OP_SERVICE_ACCOUNT_TOKEN') }}"

- name: Update existing document in 1Password
  ansible.builtin.command:
    cmd: >
      op document edit "{{ op_existing_item.stdout }}"
      "{{ local_key_backup_dir }}/{{ inventory_hostname }}_zfs_drivekey.bin"
      --vault "{{ onepassword_vault }}"
  delegate_to: localhost
  become: false
  register: op_update_result
  when:
    - op_existing_item.stdout != ""
    - vault_update_existing | default(false) | bool
  failed_when: vault_fail_on_upload_error and op_update_result.rc != 0
  environment:
    OP_SERVICE_ACCOUNT_TOKEN: "{{ lookup('env', 'OP_SERVICE_ACCOUNT_TOKEN') }}"

- name: Skip updating existing 1Password document
  ansible.builtin.debug:
    msg: "Skipped updating existing 1Password document (vault_update_existing=false) for {{ inventory_hostname }}"
  when:
    - op_existing_item.stdout != ""
    - not (vault_update_existing | default(false) | bool)

- name: Add metadata fields to 1Password item
  ansible.builtin.command:
    cmd: >
      op item edit "{{ op_existing_item.stdout | default(op_create_result.stdout) }}"
      --vault "{{ onepassword_vault }}"
      "hostname[text]={{ inventory_hostname }}"
      "zpool[text]={{ zpool_name }}"
      "key_path[text]={{ zfs_key_path }}"
  delegate_to: localhost
  become: false
  when: (op_create_result is changed) or (op_update_result is changed)
  failed_when: false
  environment:
    OP_SERVICE_ACCOUNT_TOKEN: "{{ lookup('env', 'OP_SERVICE_ACCOUNT_TOKEN') }}"

- name: Report 1Password upload status
  ansible.builtin.debug:
    msg: >
      1Password upload {{ 'successful' if (op_create_result is changed or op_update_result is changed)
      else 'skipped (no changes)' }} for {{ inventory_hostname }}
